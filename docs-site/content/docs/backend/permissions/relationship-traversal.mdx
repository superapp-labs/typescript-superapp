---
title: Relationship Traversal
description: Filter through foreign key paths to enforce access control across related tables.
---

Relationship traversal lets you define filters that follow foreign key paths across tables. Instead of filtering on a direct column, you filter through related records.

```typescript
permissions: {
  view_own_orders: {
    name: 'View own orders',
    table: 'main.orders',
    operations: { select: true },
    columns: '*',
    filter: {
      organization: {
        members: {
          user_id: { $eq: '$user.id' },
        },
      },
    },
  },
}
```

## How It Works

The engine resolves nested filter objects as FK paths. Each nesting level represents a hop through a foreign key relationship:

```
main.orders
  → organization (FK: orders.organization_id → organizations.id)
    → members (FK: members.organization_id → organizations.id)
      → user_id = $user.id
```

**Generated SQL:**

```sql
SELECT *
FROM main.orders
WHERE organization_id IN (
  SELECT id FROM main.organizations
  WHERE id IN (
    SELECT organization_id FROM main.members
    WHERE user_id = 'usr_123'
  )
)
```

## Path Resolution

The engine determines the FK path by inspecting the database schema:

1. `organization` — looks for an `organization_id` column on `main.orders` that references `main.organizations`
2. `members` — looks for a relationship between `main.organizations` and `main.members`
3. `user_id: { $eq: '$user.id' }` — the leaf condition applied to `main.members`

## Examples

### Single Hop

Filter orders by their customer's status:

```typescript
filter: {
  customer: {
    status: { $eq: 'active' },
  },
}
```

```sql
SELECT * FROM main.orders
WHERE customer_id IN (
  SELECT id FROM main.customers
  WHERE status = 'active'
)
```

### Two Hops

Filter orders where the user is a member of the order's organization:

```typescript
filter: {
  organization: {
    members: {
      user_id: { $eq: '$user.id' },
    },
  },
}
```

```sql
SELECT * FROM main.orders
WHERE organization_id IN (
  SELECT id FROM main.organizations
  WHERE id IN (
    SELECT organization_id FROM main.members
    WHERE user_id = 'usr_123'
  )
)
```

### Two Hops with Role Check

Filter orders where the user is an admin or owner of the organization:

```typescript
filter: {
  organization: {
    members: {
      user_id: { $eq: '$user.id' },
      role: { $in: ['owner', 'admin'] },
    },
  },
}
```

```sql
SELECT * FROM main.orders
WHERE organization_id IN (
  SELECT id FROM main.organizations
  WHERE id IN (
    SELECT organization_id FROM main.members
    WHERE user_id = 'usr_123'
      AND role IN ('owner', 'admin')
  )
)
```

### Combined Direct and FK Filters

Mix direct column filters with FK traversal:

```typescript
filter: {
  status: { $ne: 'deleted' },
  organization: {
    members: {
      user_id: { $eq: '$user.id' },
    },
  },
}
```

```sql
SELECT * FROM main.orders
WHERE status != 'deleted'
  AND organization_id IN (
    SELECT id FROM main.organizations
    WHERE id IN (
      SELECT organization_id FROM main.members
      WHERE user_id = 'usr_123'
    )
  )
```

## Depth Limits

The `maxFilterDepth` setting in `limits` controls how many FK hops are allowed:

```typescript
limits: {
  maxFilterDepth: 5,  // default
}
```

If a filter exceeds this depth, the request returns `400 Bad Request`.
